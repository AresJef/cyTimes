name: Upload Python Package
on:
  release:
    types: [published]

jobs:
  build_wheels:
    name: Build wheels for ${{ matrix.os }} ${{ matrix.arch }} ${{ matrix.linux_policy || '' }}

    runs-on: ${{matrix.os}}

    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux split by policy (parallel)
          - os: ubuntu-latest
            arch: x86_64
            linux_policy: manylinux
          - os: ubuntu-latest
            arch: x86_64
            linux_policy: musllinux
          # Optional extra Linux arch (adds more parallelism + time/cost)
          # - os: ubuntu-latest
          #   arch: aarch64
          #   linux_policy: manylinux
          # - os: ubuntu-latest
          #   arch: aarch64
          #   linux_policy: musllinux
          # macOS
          - os: macos-latest
            arch: auto
          # Windows
          - os: windows-latest
            arch: auto

    env:
      CIBW_SKIP: "pp27-* pp3* cp27-* cp34-* cp35-* cp36-* *_i686"
      CIBW_TEST_SKIP: "*-win_arm64"
      CIBW_BEFORE_BUILD: "pip install Cython==3.2.1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Setup QEMU
        if: runner.os == 'Linux' && matrix.arch == 'aarch64'
        uses: docker/setup-qemu-action@v3

      - name: Install Build Tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install Cython==3.2.1

      - name: Build Linux manylinux wheels
        if: runner.os == 'Linux' && matrix.linux_policy == 'manylinux'
        uses: pypa/cibuildwheel@v2.23.2
        env:
          CIBW_ARCHS_LINUX: ${{ matrix.arch }}
          CIBW_BUILD: "*-manylinux*"

      - name: Build Linux musllinux wheels
        if: runner.os == 'Linux' && matrix.linux_policy == 'musllinux'
        uses: pypa/cibuildwheel@v2.23.2
        env:
          CIBW_ARCHS_LINUX: ${{ matrix.arch }}
          CIBW_BUILD: "*-musllinux*"

      - name: Build macOS wheels
        if: runner.os == 'macOS'
        uses: pypa/cibuildwheel@v2.23.2
        env:
          CIBW_ARCHS_MACOS: universal2

      - name: Build Windows wheels
        if: runner.os == 'Windows'
        uses: pypa/cibuildwheel@v2.23.2

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.arch }}-${{ matrix.linux_policy || 'default' }}
          path: wheelhouse/*.whl
          retention-days: 1

  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - name: Install Build Tools
        run: |
          python -m pip install --upgrade pip setuptools
          python -m pip install build Cython==3.2.1
      - name: Build 'sdist'
        run: |
          python -m build --sdist --outdir dist
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz
          retention-days: 1

  upload:
    needs: [build_wheels, build_sdist]
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      - name: Publish to Test PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{secrets.TEST_PYPI_API_TOKEN}}
          repository-url: https://test.pypi.org/legacy/
      - name: Publish to PyPI
        if: startsWith(github.ref, 'refs/tags')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{secrets.PYPI_API_TOKEN}}
